{% extends "base.html" %}

{% block title %}Dashboard - Inventory Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-label">Total Products</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_stock }}</div>
            <div class="stat-label">Total Stock Units</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <!-- <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg> -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="7" x2="12" y2="14" />
                <circle cx="12" cy="17" r="1" />
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ low_stock_count }}</div>
            <div class="stat-label">Low Stock Items</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon danger">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ out_of_stock_count }}</div>
            <div class="stat-label">Out of Stock</div>
        </div>
    </div>
</div>

<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h2 class="card-title">Stock Trends (Last 30 Days)</h2>
    </div>
    <div class="card-body">
        <canvas id="stockChart" height="100"></canvas>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Low Stock Alert</h2>
            <a href="{{ url_for('low_stock') }}" class="btn btn-secondary btn-sm">View All</a>
        </div>
        <div class="table-container">
            {% if low_stock_products %}
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Stock</th>
                        <th>Reorder Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in low_stock_products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td><span class="badge badge-secondary">{{ product.sku }}</span></td>
                        <td>
                            {% if product.quantity == 0 %}
                            <span class="badge badge-danger">0</span>
                            {% else %}
                            <span class="badge badge-warning">{{ product.quantity }}</span>
                            {% endif %}
                        </td>
                        <td>{{ product.reorder_level }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
                <h3>All stocked up!</h3>
                <p>No products are running low on stock.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Transactions</h2>
            <a href="{{ url_for('transactions') }}" class="btn btn-secondary btn-sm">View All</a>
        </div>
        <div class="table-container">
            {% if recent_transactions %}
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Type</th>
                        <th>Qty</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td>{{ transaction.product.name }}</td>
                        <td>
                            {% if transaction.type == 'purchase' %}
                            <span class="badge badge-success">Purchase</span>
                            {% else %}
                            <span class="badge badge-primary">Sale</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if transaction.type == 'purchase' %}
                            <span class="type-purchase">+{{ transaction.quantity }}</span>
                            {% else %}
                            <span class="type-sale">-{{ transaction.quantity }}</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ transaction.created_at.strftime('%b %d, %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                </svg>
                <h3>No transactions yet</h3>
                <p>Transactions will appear here when you update stock.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/dashboard-stats')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('stockChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Purchases',
                            data: data.purchases,
                            borderColor: '#34a853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Sales',
                            data: data.sales,
                            borderColor: '#1a73e8',
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
});
</script>
{% endblock %}
